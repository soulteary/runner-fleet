name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

env:
  GO_VERSION: "1.26.0"

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Vet
        run: go vet ./...

      - name: Run tests
        run: go test -v ./...

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Get version information
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "dev-$(git rev-parse --short HEAD)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build
        run: |
          go build -ldflags "-s -w -X main.Version=${{ steps.version.outputs.version }}" -o runner-manager .

      - name: Init example config
        run: cp config.yaml.example config.yaml

      - name: Verify binary
        run: |
          ./runner-manager -version
          ./runner-manager -config config.yaml &
          PID=$!
          trap "kill $PID 2>/dev/null || true; wait $PID 2>/dev/null || true" EXIT
          for i in 1 2 3 4 5; do sleep 1; curl -sf http://localhost:8080/health | grep -q '"status":"ok"' && break; done
          curl -sf http://localhost:8080/health | grep -q '"status":"ok"' || (echo "health check failed"; exit 1)
          kill $PID 2>/dev/null || true
          wait $PID 2>/dev/null || true
