<!DOCTYPE html>
<html lang="{{.Lang}}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{index .T "page.title"}}</title>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --success: #3fb950;
      --warn: #d29922;
      --danger: #f85149;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans SC", sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 24px;
      line-height: 1.5;
    }
    h1 { font-size: 1.5rem; margin: 0 0 24px; color: var(--text); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h2 { margin: 0 0 16px; font-size: 1.1rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 600; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    .badge.installed { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .badge.new { background: rgba(210, 153, 34, 0.2); color: var(--warn); }
    .badge.missing { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
    .badge.unknown { background: rgba(139, 148, 158, 0.2); color: var(--muted); }
    .badge.running { background: rgba(63, 185, 80, 0.3); color: var(--success); margin-left: 4px; }
    form label { display: block; margin-top: 12px; color: var(--muted); font-size: 13px; }
    form input, form select { width: 100%; max-width: 400px; padding: 8px 12px; margin-top: 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); }
    form button {
      margin-top: 16px;
      padding: 8px 20px;
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    form button:hover { opacity: 0.9; }
    .btn-del {
      padding: 4px 10px;
      font-size: 12px;
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-del:hover { color: var(--danger); border-color: var(--danger); }
    .btn-view, .btn-edit {
      padding: 4px 10px;
      font-size: 12px;
      margin-right: 6px;
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-view:hover { color: var(--accent); border-color: var(--accent); }
    .btn-edit:hover { color: var(--warn); border-color: var(--warn); }
    .btn-start { padding: 4px 10px; font-size: 12px; margin-right: 6px; background: rgba(63, 185, 80, 0.2); color: var(--success); border: 1px solid var(--success); border-radius: 4px; cursor: pointer; }
    .btn-start:hover { opacity: 0.9; }
    .btn-stop { padding: 4px 10px; font-size: 12px; margin-right: 6px; background: rgba(248, 81, 73, 0.2); color: var(--danger); border: 1px solid var(--danger); border-radius: 4px; cursor: pointer; }
    .btn-stop:hover { opacity: 0.9; }
    .btn-save { padding: 4px 10px; font-size: 12px; margin-right: 6px; background: rgba(88, 166, 255, 0.2); color: var(--accent); border: 1px solid var(--accent); border-radius: 4px; cursor: pointer; }
    .btn-save:hover { opacity: 0.9; }
    .btn-edit-primary { padding: 4px 10px; font-size: 12px; margin-right: 6px; background: rgba(210, 153, 34, 0.2); color: var(--warn); border: 1px solid var(--warn); border-radius: 4px; cursor: pointer; }
    .btn-edit-primary:hover { opacity: 0.9; }
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
    }
    .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; font-size: 1rem; }
    .modal-close {
      padding: 4px 10px;
      font-size: 12px;
      margin-right: 6px;
      background: rgba(139, 148, 158, 0.15);
      color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
    }
    .modal-close:hover { color: var(--text); border-color: var(--text); opacity: 0.9; }
    .modal-body { padding: 20px; }
    .modal-body .row { margin-bottom: 12px; }
    .modal-body .row label { display: block; color: var(--muted); font-size: 12px; margin-bottom: 4px; }
    .modal-body .row .val { font-family: ui-monospace, monospace; font-size: 13px; word-break: break-all; }
    .btn-reveal-fix {
      padding: 4px 10px;
      font-size: 12px;
      background: transparent;
      color: var(--warn);
      border: 1px solid var(--warn);
      border-radius: 4px;
      cursor: pointer;
      margin-right: 8px;
    }
    .btn-reveal-fix:hover { opacity: 0.9; }
    .btn-copy-cmd {
      padding: 4px 10px;
      font-size: 12px;
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 4px;
      cursor: pointer;
      margin-right: 8px;
    }
    .btn-copy-cmd:hover { opacity: 0.9; }
    .modal-body input, .modal-body select { width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); margin-top: 4px; }
    .modal-footer { padding: 12px 20px; border-top: 1px solid var(--border); }
    .modal-footer button { margin-right: 8px; }
    .msg { margin-top: 12px; padding: 10px; border-radius: 6px; font-size: 14px; }
    .msg.ok { background: rgba(63, 185, 80, 0.15); color: var(--success); }
    .msg.err { background: rgba(248, 81, 73, 0.15); color: var(--danger); }
    .msg-wrap { margin-top: 12px; }
    .msg-wrap .msg { margin-top: 0; }
    .msg-wrap-actions { margin-top: 8px; }
    .msg-wrap-actions .btn-close-msg { padding: 6px 14px; font-size: 13px; background: var(--card); color: var(--muted); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }
    .msg-wrap-actions .btn-close-msg:hover { color: var(--text); border-color: var(--text); }
    .path { font-family: ui-monospace, monospace; font-size: 12px; color: var(--muted); }
    .parse-box {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    .parse-box label { display: block; margin-bottom: 8px; color: var(--muted); font-size: 13px; }
    .parse-box code { background: var(--bg); padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    .parse-row { display: flex; flex-direction: column; gap: 12px; align-items: stretch; }
    .parse-row textarea {
      width: 100%;
      min-width: 0;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: ui-monospace, monospace;
      font-size: 13px;
      resize: vertical;
    }
    .parse-btn-row { align-self: flex-start; }
    .btn-parse {
      padding: 10px 16px;
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
    }
    .btn-parse:hover { opacity: 0.9; }
    .parse-msg { margin-top: 8px; font-size: 13px; }
    .parse-msg.ok { color: var(--success); }
    .parse-msg.err { color: var(--danger); }
    .reg-ok { color: var(--success); font-size: 12px; }
    .reg-err { color: var(--danger); font-size: 12px; }
    .probe-err { color: var(--danger); font-size: 12px; }
    .github-yes { color: var(--success); }
    .github-no { color: var(--warn); }
    .github-unknown { color: var(--muted); }
  </style>
</head>
<body>
  <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap; margin-bottom: 24px;">
    <h1 style="margin: 0;">{{index .T "page.h1"}}</h1>
    <select id="langSelect" style="padding: 6px 10px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 13px; cursor: pointer;">
      <option value="en" {{if eq .Lang "en"}}selected{{end}}>English</option>
      <option value="zh" {{if eq .Lang "zh"}}selected{{end}}>中文</option>
      <option value="fr" {{if eq .Lang "fr"}}selected{{end}}>Français</option>
      <option value="de" {{if eq .Lang "de"}}selected{{end}}>Deutsch</option>
      <option value="ko" {{if eq .Lang "ko"}}selected{{end}}>한국어</option>
      <option value="ja" {{if eq .Lang "ja"}}selected{{end}}>日本語</option>
    </select>
  </div>

  <div class="card">
    <h2>{{index .T "runner_list.title"}}</h2>
    <p style="color: var(--muted); font-size: 12px; margin: 0 0 12px 0;">{{index .T "runner_list.hint"}}</p>
    <table>
      <thead>
        <tr>
          <th>{{index .T "runner_list.table.name"}}</th>
          <th>{{index .T "runner_list.table.target"}}</th>
          <th>{{index .T "runner_list.table.status"}}</th>
          {{if .Config.Runners.ContainerMode}}<th>{{index .T "runner_list.table.docker_backend"}}</th>{{end}}
          <th>{{index .T "runner_list.table.reg_github"}}</th>
          <th>{{index .T "runner_list.table.install_dir"}}</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {{range .Runners}}
        <tr>
          <td>{{.Name}}</td>
          <td>{{.TargetType}}: {{.Target}}</td>
          <td>
            <span class="badge {{.Status}}">{{.Status}}</span>
            {{if .Running}}<span class="badge running">{{index $.T "badge.running"}}</span>{{end}}
            {{if .Probe}}<br><span class="probe-err" title="{{.Probe.Error}}">{{index $.T "probe.failed"}}{{if .Probe.Type}} ({{.Probe.Type}}){{end}}</span>{{end}}
          </td>
          {{if $.Config.Runners.ContainerMode}}<td><code>{{.JobDockerBackend}}</code></td>{{end}}
          <td>
            {{if .RegistrationMessage}}
              <span class="{{if eq .Status "installed"}}reg-ok{{else}}reg-err{{end}}" title="{{.RegistrationMessage}}">{{if eq .Status "installed"}}{{index $.T "reg.registered"}}{{else}}{{index $.T "reg.failed"}}{{end}}</span>
            {{else}}
              <span class="github-unknown">—</span>
            {{end}}
            {{if .GitHubCheckAt}}
              {{if .RegisteredOnGitHub}}
                <br><span class="github-yes">{{index $.T "github.yes"}}</span>
              {{else}}
                <br><span class="github-no">{{index $.T "github.no"}}</span>
              {{end}}
            {{else}}
              {{if .RegistrationMessage}}
                <br><span class="github-unknown">{{index $.T "github.pending"}}</span>
              {{end}}
            {{end}}
          </td>
          <td class="path">{{.InstallDir}}</td>
          <td>
            {{if and (eq .Status "installed") (not .Running)}}<button type="button" class="btn-start" data-name="{{.Name}}" title="{{index $.T "btn.start_title"}}">{{index $.T "btn.start"}}</button>{{end}}
            {{if .Running}}<button type="button" class="btn-stop" data-name="{{.Name}}" title="{{index $.T "btn.stop_title"}}">{{index $.T "btn.stop"}}</button>{{end}}
            {{if eq .Status "unknown"}}
            <button type="button" class="btn-start" data-name="{{.Name}}" title="{{index $.T "btn.start_unknown_title"}}">{{index $.T "btn.start"}}</button>
            <button type="button" class="btn-stop" data-name="{{.Name}}" title="{{index $.T "btn.stop_unknown_title"}}">{{index $.T "btn.stop"}}</button>
            {{end}}
            <button type="button" class="btn-view" data-name="{{.Name}}" title="{{index $.T "btn.view_title"}}">{{index $.T "btn.view"}}</button>
            <button type="button" class="btn-edit" data-name="{{.Name}}" title="{{index $.T "btn.edit_title"}}">{{index $.T "btn.edit"}}</button>
            <button type="button" class="btn-del" data-name="{{.Name}}" title="{{index $.T "btn.del_title"}}">{{index $.T "btn.delete"}}</button>
          </td>
        </tr>
        {{end}}
        {{if not .Runners}}
        <tr><td colspan="{{if .Config.Runners.ContainerMode}}7{{else}}6{{end}}" style="color: var(--muted);">{{index .T "runner_list.empty"}}</td></tr>
        {{end}}
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2>{{index .T "form.quick_add"}}</h2>
    <div class="parse-box">
      <label>{{index .T "parse.label"}}</label>
      <div class="parse-row">
        <div>
          <textarea id="githubCommandInput" rows="3" placeholder="{{index .T "parse.placeholder"}}"></textarea>
        </div>
        <div class="parse-btn-row">
          <button type="button" id="parseCommandBtn" class="btn-parse">{{index .T "parse.btn"}}</button>
        </div>
      </div>
      <div id="parseMsg" class="parse-msg"></div>
    </div>
    <form id="addForm">
      <label>{{index .T "form.name_label"}}</label>
      <input name="name" id="addFormName" required placeholder="{{index .T "form.name_placeholder"}}">
      <label>{{index .T "form.path_label"}}</label>
      <input name="path" id="addFormPath" placeholder="{{index .T "form.path_placeholder"}}">
      <label>{{index .T "form.target_type_label"}}</label>
      <select name="target_type" id="addFormTargetType" required>
        <option value="org">{{index .T "form.target_type_org"}}</option>
        <option value="repo">{{index .T "form.target_type_repo"}}</option>
      </select>
      <label>{{index .T "form.target_label"}}</label>
      <input name="target" id="addFormTarget" required placeholder="{{index .T "form.target_placeholder"}}">
      <label>{{index .T "form.labels_label"}}</label>
      <input name="labelsStr" id="addFormLabelsStr" placeholder="{{index .T "form.labels_placeholder"}}">
      <label>{{index .T "form.token_label"}}</label>
      <input name="registration_token" id="addFormToken" type="password" placeholder="{{index .T "form.token_placeholder"}}">
      <div>
        <button type="submit">{{index .T "form.submit"}}</button>
      </div>
    </form>
    <div id="addMsgWrap" class="msg-wrap" style="display: none;">
      <div id="addMsg" class="msg"></div>
      <div class="msg-wrap-actions"><button type="button" class="btn-close-msg" id="addMsgClose">{{index .T "msg.close"}}</button></div>
    </div>
  </div>

  <div id="runnerModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">{{index .T "modal.title"}}</h3>
        <button type="button" class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modalView">
          <div class="row"><label>{{index .T "modal.label_name"}}</label><div class="val" id="vName"></div></div>
          <div class="row"><label>{{index .T "modal.label_path"}}</label><div class="val" id="vPath"></div></div>
          <div class="row"><label>{{index .T "modal.label_target_type"}}</label><div class="val" id="vTargetType"></div></div>
          <div class="row"><label>{{index .T "modal.label_target"}}</label><div class="val" id="vTarget"></div></div>
          <div class="row"><label>{{index .T "modal.label_labels"}}</label><div class="val" id="vLabels"></div></div>
          <div class="row"><label>{{index .T "modal.label_install_dir"}}</label><div class="val path" id="vInstallDir"></div></div>
          <div class="row" id="vJobDockerBackendRow" style="display:none"><label>{{index .T "modal.label_docker_backend"}}</label><div class="val"><code id="vJobDockerBackend"></code></div></div>
          <div class="row"><label>{{index .T "modal.label_status"}}</label><div class="val"><span id="vStatus"></span><span id="vRunning"></span></div></div>
          <div class="row"><label>{{index .T "modal.label_probe_error_type"}}</label><div class="val" id="vProbeErrorType"></div></div>
          <div class="row"><label>{{index .T "modal.label_suggestion"}}</label><div class="val" id="vProbeSuggestion"></div></div>
          <div class="row"><label>{{index .T "modal.label_check_cmd"}}</label><div class="val"><button type="button" id="vCopyCheckCmdBtn" class="btn-copy-cmd" style="display:none">{{index .T "modal.btn_copy_cmd"}}</button><span id="vProbeCheckCommand"></span></div></div>
          <div class="row"><label>{{index .T "modal.label_fix_cmd"}}</label><div class="val"><button type="button" id="vRevealFixCmdBtn" class="btn-reveal-fix" style="display:none">{{index .T "modal.btn_reveal_fix"}}</button><button type="button" id="vCopyFixCmdBtn" class="btn-copy-cmd" style="display:none">{{index .T "modal.btn_copy_cmd"}}</button><span id="vProbeFixCommand"></span></div></div>
          <div class="row"><label>{{index .T "modal.label_probe_error"}}</label><div class="val" id="vProbeError"></div></div>
          <div class="row"><label>{{index .T "modal.label_reg_result"}}</label><div class="val" id="vRegistrationMessage"></div></div>
          <div class="row"><label>{{index .T "modal.label_reg_checked_at"}}</label><div class="val" id="vRegistrationCheckedAt"></div></div>
          <div class="row"><label>{{index .T "modal.label_github_display"}}</label><div class="val" id="vRegisteredOnGitHub"></div></div>
          <div class="row"><label>{{index .T "modal.label_github_check_at"}}</label><div class="val" id="vGitHubCheckAt"></div></div>
        </div>
        <form id="modalEditForm" style="display:none">
          <input type="hidden" name="name" id="eName">
          <div class="row"><label>{{index .T "modal.label_name"}}</label><input type="text" name="nameDisplay" id="eNameDisplay" readonly style="opacity:0.8"></div>
          <div class="row"><label>{{index .T "modal.label_path"}}</label><input type="text" name="path" id="ePath" placeholder="{{index .T "modal.edit_path_placeholder"}}"></div>
          <div class="row"><label>{{index .T "form.target_type_label"}}</label><select name="target_type" id="eTargetType" required><option value="org">{{index .T "form.target_type_org"}}</option><option value="repo">{{index .T "form.target_type_repo"}}</option></select></div>
          <div class="row"><label>{{index .T "form.target_label"}}</label><input type="text" name="target" id="eTarget" required placeholder="{{index .T "modal.edit_target_placeholder"}}"></div>
          <div class="row"><label>{{index .T "modal.label_labels"}}</label><input type="text" name="labelsStr" id="eLabelsStr" placeholder="{{index .T "modal.edit_labels_placeholder"}}"></div>
        </form>
        <div id="modalMsg" class="msg" style="display:none; margin-top:12px"></div>
      </div>
      <div class="modal-footer" id="modalFooter">
        <span id="modalStartStopSpan" style="display:none; margin-right: auto;">
          <button type="button" id="modalStartBtnFooter" class="btn-start" style="display:none">{{index .T "modal.btn_start"}}</button>
          <button type="button" id="modalStopBtnFooter" class="btn-stop" style="display:none">{{index .T "modal.btn_stop"}}</button>
        </span>
        <button type="button" id="modalEditBtn" class="btn-edit-primary" style="display:none">{{index .T "modal.btn_edit"}}</button>
        <button type="button" id="modalSaveBtn" class="btn-save" style="display:none">{{index .T "modal.btn_save"}}</button>
        <button type="button" class="modal-close" id="modalCancelBtn">{{index .T "modal.btn_close"}}</button>
      </div>
    </div>
  </div>

  <script>
    window.__I18N = {{.TJSON}};
    function t(key) { return (window.__I18N && window.__I18N[key]) || key; }
    document.getElementById('langSelect').addEventListener('change', function() {
      var lang = this.value;
      document.cookie = 'lang=' + encodeURIComponent(lang) + ';path=/;max-age=31536000';
      location.reload();
    });
    // Parse GitHub config.sh command and fill add-runner form
    function sanitizeRunnerName(s) {
      if (!s || typeof s !== 'string') return '';
      return s.replace(/\.\./g, '').replace(/[/\\]/g, '-').trim() || 'runner';
    }

    function parseGitHubConfigCommand(text) {
      if (!text || typeof text !== 'string') return { ok: false, message: t('parse.please_enter_command') };
      const trimmed = text.trim();
      const urlMatch = trimmed.match(/\-\-url\s+["']?([^\s"']+)["']?/);
      const tokenMatch = trimmed.match(/\-\-token\s+["']?([^\s"']+)["']?/);
      if (!urlMatch) return { ok: false, message: t('parse.no_url') };
      const url = urlMatch[1].trim();
      let parsedUrl;
      try {
        parsedUrl = new URL(url);
      } catch (e) {
        return { ok: false, message: t('parse.invalid_url') };
      }
      const pathParts = parsedUrl.pathname.replace(/^\/+|\/+$/g, '').split('/').filter(Boolean);
      let targetType = 'org';
      let target = '';
      let suggestedName = '';
      if (pathParts.length >= 2) {
        targetType = 'repo';
        target = pathParts[0] + '/' + pathParts[1];
        suggestedName = sanitizeRunnerName(pathParts[1]);
      } else if (pathParts.length === 1) {
        target = pathParts[0];
        suggestedName = sanitizeRunnerName(pathParts[0]);
      } else {
        return { ok: false, message: t('parse.cannot_parse') };
      }
      const token = tokenMatch ? tokenMatch[1].trim() : '';
      return {
        ok: true,
        target_type: targetType,
        target: target,
        registration_token: token,
        suggested_name: suggestedName || 'runner'
      };
    }

    document.getElementById('parseCommandBtn').addEventListener('click', function() {
      const input = document.getElementById('githubCommandInput');
      const msgEl = document.getElementById('parseMsg');
      const result = parseGitHubConfigCommand(input.value);
      msgEl.textContent = '';
      msgEl.className = 'parse-msg';
      if (!result.ok) {
        msgEl.className = 'parse-msg err';
        msgEl.textContent = result.message;
        return;
      }
      document.getElementById('addFormTargetType').value = result.target_type;
      document.getElementById('addFormTarget').value = result.target;
      document.getElementById('addFormToken').value = result.registration_token || '';
      if (result.suggested_name && !document.getElementById('addFormName').value) {
        document.getElementById('addFormName').value = result.suggested_name;
        document.getElementById('addFormPath').value = '';
      }
      msgEl.className = 'parse-msg ok';
      var filled = t('parse.filled').replace('{{"{{"}}target_type{{"}}"}}', result.target_type).replace('{{"{{"}}target{{"}}"}}', result.target).replace('{{"{{"}}token_part{{"}}"}}', result.registration_token ? t('parse.filled_token') : '');
      msgEl.textContent = filled;
    });

    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = {};
      fd.forEach((v, k) => { if (v) body[k] = v; });
      if (body.labelsStr) {
        body.labels = body.labelsStr.split(',').map(s => s.trim()).filter(Boolean);
        delete body.labelsStr;
      }
      const msgEl = document.getElementById('addMsg');
      const msgWrap = document.getElementById('addMsgWrap');
      const submitBtn = e.target.querySelector('button[type="submit"]');
      msgWrap.style.display = 'none';
      msgEl.innerHTML = t('msg.adding');
      msgEl.className = 'msg';
      msgWrap.style.display = 'block';
      if (submitBtn) submitBtn.disabled = true;
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5 * 60 * 1000);
        const r = await fetch('/api/runners', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          msgEl.className = 'msg err';
          msgEl.textContent = data.message || r.statusText || t('msg.request_failed');
          if (submitBtn) submitBtn.disabled = false;
          msgWrap.style.display = 'block';
          return;
        }
        msgEl.className = 'msg ok';
        msgEl.innerHTML = data.message + (data.install_dir ? '<br><span class="path">' + data.install_dir + '</span>' : '');
        if (data.output) msgEl.innerHTML += '<pre style="margin-top:8px;font-size:12px">' + escapeHtml(data.output) + '</pre>';
        if (data.queued) {
          msgEl.innerHTML += '<br><span style="font-size:12px;color:var(--muted)">' + t('msg.reload_in_5s') + '</span>';
          setTimeout(function() { location.reload(); }, 5000);
        }
        e.target.reset();
        if (submitBtn) submitBtn.disabled = false;
        msgWrap.style.display = 'block';
      } catch (err) {
        if (submitBtn) submitBtn.disabled = false;
        msgEl.className = 'msg err';
        msgEl.textContent = err.name === 'AbortError' ? t('msg.timeout_refresh') : (err.message || t('msg.request_failed'));
        msgWrap.style.display = 'block';
      }
    });
    document.getElementById('addMsgClose').addEventListener('click', function() {
      document.getElementById('addMsgWrap').style.display = 'none';
      location.reload();
    });
    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }
    function resolveProbeSuggestion(data) {
      if (data && data.probe && data.probe.suggestion) return data.probe.suggestion;
      return t('probe.default_suggestion');
    }
    function resolveProbeError(data) {
      if (data && data.probe && data.probe.error) return data.probe.error;
      return '';
    }
    function resolveProbeCheckCommand(data) {
      if (data && data.probe && data.probe.check_command) return data.probe.check_command;
      return 'docker compose ps && docker logs --tail=200 runner-manager';
    }
    function resolveProbeFixCommand(data) {
      if (data && data.probe && data.probe.fix_command) return data.probe.fix_command;
      return 'docker compose up -d --force-recreate';
    }
    function resolveProbeType(data) {
      if (data && data.probe && data.probe.type) return data.probe.type;
      return 'unknown';
    }
    const modal = document.getElementById('runnerModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalView = document.getElementById('modalView');
    const modalEditForm = document.getElementById('modalEditForm');
    const modalEditBtn = document.getElementById('modalEditBtn');
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    const modalMsg = document.getElementById('modalMsg');
    const revealFixBtn = document.getElementById('vRevealFixCmdBtn');
    const copyCheckBtn = document.getElementById('vCopyCheckCmdBtn');
    const copyFixBtn = document.getElementById('vCopyFixCmdBtn');
    const probeFixCmdEl = document.getElementById('vProbeFixCommand');
    const probeCheckCmdEl = document.getElementById('vProbeCheckCommand');
    let currentProbeCheckCommand = '';
    let currentProbeFixCommand = '';
    let probeFixRevealed = false;

    async function copyCommandText(text) {
      if (!text) return false;
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (_) {
        // ignore and fallback below
      }
      // 回退：在不支持/拒绝 clipboard API 的环境里尝试 execCommand
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.top = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand && document.execCommand('copy');
        document.body.removeChild(ta);
        return !!ok;
      } catch (_) {
        return false;
      }
    }

    function openModal(mode, name) {
      modalMsg.style.display = 'none';
      if (mode === 'view') {
        modalTitle.textContent = t('modal.view_title');
        modalView.style.display = 'block';
        modalEditForm.style.display = 'none';
        modalEditBtn.style.display = 'inline-block';
        modalSaveBtn.style.display = 'none';
        document.getElementById('modalStartStopSpan').style.display = 'none';
        fetch('/api/runners/' + encodeURIComponent(name))
          .then(r => r.ok ? r.json() : Promise.reject(r))
          .then(data => {
            document.getElementById('vName').textContent = data.name || '';
            document.getElementById('vPath').textContent = data.path || data.name || '';
            document.getElementById('vTargetType').textContent = data.target_type || '';
            document.getElementById('vTarget').textContent = data.target || '';
            document.getElementById('vLabels').textContent = Array.isArray(data.labels) ? data.labels.join(', ') : (data.labels || '');
            document.getElementById('vInstallDir').textContent = data.install_dir || '';
            var jdbRow = document.getElementById('vJobDockerBackendRow');
            var jdbEl = document.getElementById('vJobDockerBackend');
            if (data.job_docker_backend) {
              jdbRow.style.display = '';
              jdbEl.textContent = data.job_docker_backend;
            } else {
              jdbRow.style.display = 'none';
            }
            document.getElementById('vStatus').innerHTML = '<span class="badge ' + escapeHtml(data.status || '') + '">' + escapeHtml(data.status || '') + '</span>';
            document.getElementById('vRunning').innerHTML = data.running ? ' <span class="badge running">' + t('badge.running') + '</span>' : '';
            const probeError = resolveProbeError(data);
            document.getElementById('vProbeErrorType').textContent = probeError ? resolveProbeType(data) : '—';
            document.getElementById('vProbeSuggestion').textContent = probeError ? resolveProbeSuggestion(data) : '—';
            currentProbeCheckCommand = probeError ? resolveProbeCheckCommand(data) : '';
            probeCheckCmdEl.textContent = currentProbeCheckCommand || '—';
            copyCheckBtn.style.display = currentProbeCheckCommand ? 'inline-block' : 'none';
            currentProbeFixCommand = probeError ? resolveProbeFixCommand(data) : '';
            probeFixRevealed = false;
            probeFixCmdEl.textContent = probeError ? t('probe.fix_hidden_hint') : '—';
            revealFixBtn.style.display = probeError ? 'inline-block' : 'none';
            copyFixBtn.style.display = 'none';
            document.getElementById('vProbeError').textContent = probeError || '—';
            document.getElementById('vRegistrationMessage').textContent = data.registration_message || '—';
            document.getElementById('vRegistrationCheckedAt').textContent = data.registration_checked_at || '—';
            var gh = data.registered_on_github;
            var ghEl = document.getElementById('vRegisteredOnGitHub');
            if (gh === true) ghEl.innerHTML = '<span class="github-yes">' + t('modal.gh_yes') + '</span>';
            else if (gh === false) ghEl.innerHTML = '<span class="github-no">' + t('modal.gh_no') + '</span>';
            else ghEl.textContent = t('modal.gh_unchecked');
            document.getElementById('vGitHubCheckAt').textContent = data.github_check_at || '—';
            const startStopSpan = document.getElementById('modalStartStopSpan');
            const startBtn = document.getElementById('modalStartBtnFooter');
            const stopBtn = document.getElementById('modalStopBtnFooter');
            startBtn.setAttribute('data-name', name);
            stopBtn.setAttribute('data-name', name);
            if (data.status === 'installed') {
              startStopSpan.style.display = 'inline-block';
              startBtn.style.display = data.running ? 'none' : 'inline-block';
              stopBtn.style.display = data.running ? 'inline-block' : 'none';
            } else if (data.status === 'unknown') {
              // 状态探测失败时允许用户手动尝试启停进行自愈
              startStopSpan.style.display = 'inline-block';
              startBtn.style.display = 'inline-block';
              stopBtn.style.display = 'inline-block';
            } else {
              startBtn.style.display = 'none';
              stopBtn.style.display = 'none';
            }
          })
          .catch(() => { modalMsg.textContent = t('msg.load_failed'); modalMsg.style.display = 'block'; modalMsg.className = 'msg err'; });
      } else {
        document.getElementById('modalStartStopSpan').style.display = 'none';
        modalTitle.textContent = t('modal.edit_title');
        modalView.style.display = 'none';
        modalEditForm.style.display = 'block';
        modalEditBtn.style.display = 'none';
        modalSaveBtn.style.display = 'inline-block';
        fetch('/api/runners/' + encodeURIComponent(name))
          .then(r => r.ok ? r.json() : Promise.reject(r))
          .then(data => {
            document.getElementById('eName').value = data.name || '';
            document.getElementById('eNameDisplay').value = data.name || '';
            document.getElementById('ePath').value = data.path || '';
            document.getElementById('eTargetType').value = data.target_type || 'org';
            document.getElementById('eTarget').value = data.target || '';
            document.getElementById('eLabelsStr').value = Array.isArray(data.labels) ? data.labels.join(', ') : (data.labels || '');
          })
          .catch(() => { modalMsg.textContent = t('msg.load_failed'); modalMsg.style.display = 'block'; modalMsg.className = 'msg err'; });
      }
      modal.classList.add('show');
    }

    function closeModal() {
      modal.classList.remove('show');
    }

    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('show')) closeModal(); });

    document.getElementById('modalEditBtn').addEventListener('click', () => {
      const name = document.getElementById('vName').textContent;
      if (name) openModal('edit', name);
    });

    document.getElementById('modalSaveBtn').addEventListener('click', async () => {
      const name = document.getElementById('eName').value;
      if (!name) return;
      const labelsStr = document.getElementById('eLabelsStr').value.trim();
      const labels = labelsStr ? labelsStr.split(',').map(s => s.trim()).filter(Boolean) : [];
      const body = {
        name: name,
        path: document.getElementById('ePath').value.trim() || undefined,
        target_type: document.getElementById('eTargetType').value,
        target: document.getElementById('eTarget').value.trim(),
        labels: labels
      };
      modalMsg.style.display = 'none';
      try {
        const r = await fetch('/api/runners/' + encodeURIComponent(name), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          modalMsg.className = 'msg err';
          modalMsg.textContent = data.message || r.statusText;
          modalMsg.style.display = 'block';
          return;
        }
        modalMsg.className = 'msg ok';
        modalMsg.textContent = data.message || t('msg.saved');
        modalMsg.style.display = 'block';
        setTimeout(() => { closeModal(); location.reload(); }, 800);
      } catch (e) {
        modalMsg.className = 'msg err';
        modalMsg.textContent = e.message;
        modalMsg.style.display = 'block';
      }
    });

    document.querySelectorAll('.btn-view').forEach(btn => {
      btn.addEventListener('click', () => openModal('view', btn.getAttribute('data-name')));
    });
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', () => openModal('edit', btn.getAttribute('data-name')));
    });

    document.querySelectorAll('.btn-del').forEach(btn => {
      btn.addEventListener('click', async () => {
        const name = btn.getAttribute('data-name');
        if (!name || !confirm(t('confirm_remove').replace('{{"{{"}}name{{"}}"}}', name))) return;
        try {
          const r = await fetch('/api/runners/' + encodeURIComponent(name), { method: 'DELETE' });
          const data = await r.json().catch(() => ({}));
          if (r.ok) location.reload();
          else alert(data.message || r.statusText);
        } catch (e) { alert(e.message); }
      });
    });

    async function runnerAction(name, action) {
      try {
        const r = await fetch('/api/runners/' + encodeURIComponent(name) + '/' + action, { method: 'POST' });
        const data = await r.json().catch(() => ({}));
        if (r.ok) {
          const probeError = resolveProbeError(data);
          if (probeError) {
            const probeType = resolveProbeType(data);
            const checkMsg =
              (data.message || t('msg.action_done')) +
              '\n\n' + t('probe.alert_type') + probeType +
              '\n' + t('probe.alert_suggestion') + resolveProbeSuggestion(data) +
              '\n' + t('probe.alert_check_cmd') + resolveProbeCheckCommand(data) +
              '\n' + t('probe.alert_error') + probeError;
            alert(checkMsg);
            if (confirm(t('confirm_show_fix_cmd'))) {
              alert(t('probe.alert_fix_cmd') + '\n' + resolveProbeFixCommand(data));
            }
          }
          location.reload();
        }
        else { alert(data.message || r.statusText || t('msg.request_failed')); }
      } catch (e) { alert(e.message); }
    }
    revealFixBtn.addEventListener('click', () => {
      if (!currentProbeFixCommand) return;
      if (!confirm(t('confirm_reveal_fix'))) return;
      probeFixCmdEl.textContent = currentProbeFixCommand;
      probeFixRevealed = true;
      copyFixBtn.style.display = 'inline-block';
    });
    copyCheckBtn.addEventListener('click', async () => {
      if (!currentProbeCheckCommand) return;
      const ok = await copyCommandText(currentProbeCheckCommand);
      alert(ok ? t('msg.check_cmd_copied') : t('msg.copy_failed'));
    });
    copyFixBtn.addEventListener('click', async () => {
      if (!probeFixRevealed || !currentProbeFixCommand) {
        alert(t('msg.show_fix_first'));
        return;
      }
      const ok = await copyCommandText(currentProbeFixCommand);
      alert(ok ? t('msg.fix_cmd_copied') : t('msg.copy_failed'));
    });
    document.querySelectorAll('.btn-start').forEach(btn => {
      if (btn.id === 'modalStartBtnFooter') return;
      btn.addEventListener('click', () => runnerAction(btn.getAttribute('data-name'), 'start'));
    });
    document.querySelectorAll('.btn-stop').forEach(btn => {
      if (btn.id === 'modalStopBtnFooter') return;
      btn.addEventListener('click', () => runnerAction(btn.getAttribute('data-name'), 'stop'));
    });
    document.getElementById('modalStartBtnFooter').addEventListener('click', () => runnerAction(document.getElementById('modalStartBtnFooter').getAttribute('data-name'), 'start'));
    document.getElementById('modalStopBtnFooter').addEventListener('click', () => runnerAction(document.getElementById('modalStopBtnFooter').getAttribute('data-name'), 'stop'));
  </script>
</body>
</html>
