# Runner Fleet - GitHub Actions Runner 管理 + DinD
# 详见 docs/docker.md
#
# === 首次使用 ===
# 1. 复制配置：cp config.yaml.example config.yaml
# 2. 确认 config.yaml 中 runners.base_path 为 /app/runners（与下方 volumes 一致）
# 3. 宿主机目录权限（Manager 以 UID 1001 运行）：
#      chown 1001:1001 config.yaml
#      mkdir -p runners && chown 1001:1001 runners
# 4. 可选：复制 .env.example 为 .env，设置 MANAGER_IMAGE 等（见下方 services.runner-manager.image）
# 5. 若启用容器模式（runners.container_mode: true）：
#      - 取消 config.yaml 中 container_mode 等注释
#      - 设置 volume_host_path 为宿主机 runners 绝对路径（例如：realpath runners 或 $(cd . && pwd)/runners）
#      - 设置 container_image 为 CI 推送的 ghcr.io/<owner>/<repo>:main-runner（与 Manager 同镜像名，tag 带 -runner），或本地构建的镜像 tag
#      - Manager 需能访问宿主机 Docker（创建/启停 Runner 容器）：下方已配置 group_add，请将 999 改为宿主机 docker 组 GID（getent group docker | cut -d: -f3）；或改用 user: "0:0" 以 root 运行
#
# === 两种运行模式 ===
# - 默认（container_mode: false）：Runner 进程在 Manager 容器内运行，Job 需 Docker 时可在 .env 设 DOCKER_HOST=tcp://runner-dind:2375 使用 DinD
# - 容器模式（container_mode: true）：每个 Runner 独立容器，Manager 必须用宿主机 Docker（socket）创建/启停 Runner；DinD 仅供 Runner 容器内 Job 使用。请勿在 .env 中设置 DOCKER_HOST=tcp://runner-dind:2375，否则点击启动会报错

# DinD 为可选：仅当 config.yaml 中 job_docker_backend: dind 时需要。
# 启动 DinD：docker compose --profile dind up -d
# 仅 Manager（host-socket 或 none）：docker compose up -d
services:
  runner-dind:
    profiles:
      - dind
    image: docker:dind
    container_name: runner-dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ""
    command: ["--tls=false"]
    volumes:
      - dind-storage:/var/lib/docker
    networks:
      - runner-net
    restart: unless-stopped

  runner-manager:
    # 使用本仓库 CI 镜像时可设 .env：MANAGER_IMAGE=ghcr.io/<owner>/<repo>:main
    image: ${MANAGER_IMAGE:-ghcr.io/soulteary/runner-fleet:main}
    container_name: runner-manager
    # 使用 job_docker_backend: dind 时请先启动 DinD：docker compose --profile dind up -d
    # 容器模式下必须用宿主机 socket，否则 Manager 无法创建 Runner 容器；默认 unix，勿改为 tcp://runner-dind:2375
    environment:
      DOCKER_HOST: ${DOCKER_HOST:-unix:///var/run/docker.sock}
    ports:
      - "${MANAGER_PORT:-8080}:8080"
    volumes:
      - ./config.yaml:/app/config.yaml
      - ./runners:/app/runners
      - /var/run/docker.sock:/var/run/docker.sock
    # 容器模式需 Manager 访问宿主机 Docker：加入宿主机 docker 组（GID 用 getent group docker 查看，常见为 999）
    group_add:
      - "${DOCKER_GID:-999}"
    networks:
      - runner-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3

# runner-net 设为 external，避免 compose down 时删除网络导致已注册的 Runner 容器
#（由 Manager 动态创建、未在 compose 中定义）无法启动。首次使用请执行：docker network create runner-net
networks:
  runner-net:
    external: true

volumes:
  dind-storage:
